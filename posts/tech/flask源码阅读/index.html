<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Flask源码阅读 | Puffin Jiang&#39;s Blog</title>
<meta name="keywords" content="Flask">
<meta name="description" content="记录一下阅读Flask源码的过程">
<meta name="author" content="
作者：Puffin Jiang">
<link rel="canonical" href="https://puffinjiang.github.io/posts/tech/flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.34bf4cb683cae568b9d188811604e39e36b24e661d45a315724d1459ee1160b4.css" integrity="sha256-NL9MtoPK5Wi50YiBFgTjnjayTmYdRaMVck0UWe4RYLQ=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://cdn.jsdelivr.net/gh/puffinjiang/oss@main/uPic/1661409751396.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://cdn.jsdelivr.net/gh/puffinjiang/oss@main/uPic/1661409677120.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://cdn.jsdelivr.net/gh/puffinjiang/oss@main/uPic/1661409656713.png">
<link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/puffinjiang/oss@main/uPic/1661409703162.png">
<link rel="mask-icon" href="https://cdn.jsdelivr.net/gh/puffinjiang/oss@main/uPic/1661412250612.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Flask源码阅读" />
<meta property="og:description" content="记录一下阅读Flask源码的过程" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://puffinjiang.github.io/posts/tech/flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-01T20:30:18+08:00" />
<meta property="article:modified_time" content="2022-09-19T20:30:18+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Flask源码阅读"/>
<meta name="twitter:description" content="记录一下阅读Flask源码的过程"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "📚文章",
      "item": "https://puffinjiang.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "👨🏻‍💻技术",
      "item": "https://puffinjiang.github.io/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Flask源码阅读",
      "item": "https://puffinjiang.github.io/posts/tech/flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Flask源码阅读",
  "name": "Flask源码阅读",
  "description": "记录一下阅读Flask源码的过程",
  "keywords": [
    "Flask"
  ],
  "articleBody": "Flask简介 Flask是一个“微” python web 框架，只实现了最基本的功能，简单、灵活、可拓展性强。\n简单：使用简单，通过 @app.route() 装饰器即可配置路由 灵活：配置灵活，支持多种不同类型的配置方式。可自定义 使用dict对象 使用环境变量 app.config.from_envvar() 使用配置文件 app.config.from_file() 包括json、toml 可拓展性强：可自定义其他部分的组件，如 flask-SQLAlchemy、flask-session 等 依赖 flask依赖的核心组件有2个： werkzeug 和 jinja。 jinja 是一个模版引擎，负责模版的渲染，werkzeug 是一个 WSGI 工具集的库\n启动流程 在Flask的官方文档中给了一个 ‘Hello World’ 启动案例，我们本地启动一下\n1 2 3 4 5 6 7 8 9 10 from flask import Flask app = Flask(__name__) @app.route(\"/\") def hello_world(): return \"Hello, World!\n\" if __name__ == '__main__': app.run(\"127.0.0.1\", 5000) 我们可以看出来，启动的时候首先调用了 app.run() 方法，我们来看一下这个方法\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 class Flask(Scaffold): def run( self, host: t.Optional[str] = None, port: t.Optional[int] = None, debug: t.Optional[bool] = None, load_dotenv: bool = True, **options: t.Any, ) -\u003e None: # Change this into a no-op if the server is invoked from the # command line. Have a look at cli.py for more information. if os.environ.get(\"FLASK_RUN_FROM_CLI\") == \"true\": from .debughelpers import explain_ignored_app_run explain_ignored_app_run() return if get_load_dotenv(load_dotenv): cli.load_dotenv() # if set, let env vars override previous values if \"FLASK_ENV\" in os.environ: self.env = get_env() self.debug = get_debug_flag() elif \"FLASK_DEBUG\" in os.environ: self.debug = get_debug_flag() # debug passed to method overrides all other sources if debug is not None: self.debug = bool(debug) server_name = self.config.get(\"SERVER_NAME\") sn_host = sn_port = None if server_name: sn_host, _, sn_port = server_name.partition(\":\") if not host: if sn_host: host = sn_host else: host = \"127.0.0.1\" if port or port == 0: port = int(port) elif sn_port: port = int(sn_port) else: port = 5000 options.setdefault(\"use_reloader\", self.debug) options.setdefault(\"use_debugger\", self.debug) options.setdefault(\"threaded\", True) cli.show_server_banner(self.env, self.debug, self.name, False) from werkzeug.serving import run_simple try: run_simple(t.cast(str, host), port, self, **options) finally: # reset the first request information if the development server # reset normally. This makes it possible to restart the server # without reloader and that stuff from an interactive shell. self._got_first_request = False 我们可以看到，前面一部分主要是处理一些启动参数。在参数处理完成之后，调用了 werkzeug.serving 中的 run_simple 函数，能看到这个函数传入了一个 self 参数，即我们的 flask application，我们再进入这个 run_simple 当中。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 # werkzeug相关代码 def run_simple( hostname: str, port: int, application: \"WSGIApplication\", use_reloader: bool = False, use_debugger: bool = False, use_evalex: bool = True, extra_files: t.Optional[t.Iterable[str]] = None, exclude_patterns: t.Optional[t.Iterable[str]] = None, reloader_interval: int = 1, reloader_type: str = \"auto\", threaded: bool = False, processes: int = 1, request_handler: t.Optional[t.Type[WSGIRequestHandler]] = None, static_files: t.Optional[t.Dict[str, t.Union[str, t.Tuple[str, str]]]] = None, passthrough_errors: bool = False, ssl_context: t.Optional[_TSSLContextArg] = None, ) -\u003e None: if not isinstance(port, int): raise TypeError(\"port must be an integer\") if static_files: from .middleware.shared_data import SharedDataMiddleware # 静态文件的加载 application = SharedDataMiddleware(application, static_files) if use_debugger: from .debug import DebuggedApplication # Debug调试 application = DebuggedApplication(application, evalex=use_evalex) if not is_running_from_reloader(): # 启动前 socket 的准备和检查 ，使用IPV4还是IPV6、端口是否占用 s = prepare_socket(hostname, port) fd = s.fileno() os.environ[\"WERKZEUG_SERVER_FD\"] = str(fd) else: fd = int(os.environ[\"WERKZEUG_SERVER_FD\"]) srv = make_server( hostname, port, application, threaded, processes, request_handler, passthrough_errors, ssl_context, fd=fd, ) if not is_running_from_reloader(): srv.log_startup() if use_reloader: from ._reloader import run_with_reloader run_with_reloader( srv.serve_forever, extra_files=extra_files, exclude_patterns=exclude_patterns, interval=reloader_interval, reloader_type=reloader_type, ) else: srv.serve_forever() 从上面的代码我们可以看到有两处关键的函数调用，一处是 make_server ，另外一处是 serve_forever 。我们先看 make_server 做了什么：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 # werkzeug相关代码 def make_server( host: str, port: int, app: \"WSGIApplication\", threaded: bool = False, processes: int = 1, request_handler: t.Optional[t.Type[WSGIRequestHandler]] = None, passthrough_errors: bool = False, ssl_context: t.Optional[_TSSLContextArg] = None, fd: t.Optional[int] = None, ) -\u003e BaseWSGIServer: if threaded and processes \u003e 1: raise ValueError(\"Cannot have a multi-thread and multi-process server.\") if threaded: # ThreadedWSGIServer 继承了 BaseWSGIServer return ThreadedWSGIServer( host, port, app, request_handler, passthrough_errors, ssl_context, fd=fd ) if processes \u003e 1: # ForkingWSGIServer 继承了 BaseWSGIServer return ForkingWSGIServer( host, port, app, processes, request_handler, passthrough_errors, ssl_context, fd=fd, ) return BaseWSGIServer( host, port, app, request_handler, passthrough_errors, ssl_context, fd=fd ) 能看到这里是返回了一个 BaseWSGIServer 实例化对象。BaseWSGIServer 在初始化的时候主要做了 两件事情，一是 绑定IP和端口以及监听；二是添加 WSGIRequestHandler 这个请求处理器。\n我们再来看看 serve_forever 做了什么：\n1 2 3 4 5 6 7 8 9 10 # werkzeug相关代码 class BaseWSGIServer(HTTPServer): def serve_forever(self, poll_interval: float = 0.5) -\u003e None: try: super().serve_forever(poll_interval=poll_interval) except KeyboardInterrupt: pass finally: self.server_close() 再来进一步看看父类的 serve_forever 做了什么：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 # werkzeug相关代码 class BaseServer: def serve_forever(self, poll_interval=0.5): \"\"\"Handle one request at a time until shutdown. Polls for shutdown every poll_interval seconds. Ignores self.timeout. If you need to do periodic tasks, do them in another thread. \"\"\" self.__is_shut_down.clear() try: # XXX: Consider using another file descriptor or connecting to the # socket to wake this up instead of polling. Polling reduces our # responsiveness to a shutdown request and wastes cpu at all other # times. # I/O多路复用选择器，有poll时选poll with _ServerSelector() as selector: selector.register(self, selectors.EVENT_READ) while not self.__shutdown_request: # 轮询 ready = selector.select(poll_interval) # bpo-35017: shutdown() called during select(), exit immediately. if self.__shutdown_request: break if ready: self._handle_request_noblock() self.service_actions() finally: self.__shutdown_request = False self.__is_shut_down.set() 我们可以看到的是直接跳到了 BaseServer 这个类，这因为 BaseWSGIServer –\u003e HTTPServer –\u003e TCPServer –\u003e BaseServer 他们之间有继承关系。此处选用了 PollSelector 作为 I/O多路复用选择器，关于I/O多路复用就不详说了。当有活跃的文件描述符时，执行 _handle_request_noblock()方法，到了这里，我们的应用启动并开始监听相关的端口了。\n请求处理过程 在上面我们已经说到了应用的启动过程，接下来看一看当接收到请求之后是怎么处理的。 上面说到，当有活跃的文件描述符会执行 _handle_request_noblock() 方法，来看一下这个方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # werkzeug相关代码 class BaseServer: def _handle_request_noblock(self): \"\"\"Handle one request, without blocking. I assume that selector.select() has returned that the socket is readable before this function was called, so there should be no risk of blocking in get_request(). \"\"\" try: request, client_address = self.get_request() except OSError: return if self.verify_request(request, client_address): try: self.process_request(request, client_address) except Exception: self.handle_error(request, client_address) self.shutdown_request(request) except: self.shutdown_request(request) raise else: self.shutdown_request(request) 在这段代码里我们可以看出来，这里是调用了 process_request 方法去处理接收到的request，这个时候就到了我们前面提到的 WSGIRequestHandler 这个请求处理器了。 WSGIRequestHandler 是 BaseRequestHandler 的子类，看看初始化相关的代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # werkzeug相关代码 class BaseRequestHandler: def __init__(self, request, client_address, server): self.request = request self.client_address = client_address self.server = server self.setup() try: self.handle() finally: self.finish() def setup(self): pass def handle(self): pass def finish(self): pass 从上面的代码中可以看到，初始化时调用了 handle 方法，在 handle 方法里是调用了 handle_one_request 方法，我们来看看这个方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 # werkzeug相关代码 class BaseHTTPRequestHandler(socketserver.StreamRequestHandler): def handle_one_request(self): \"\"\"Handle a single HTTP request. You normally don't need to override this method; see the class __doc__ string for information on how to handle specific HTTP commands such as GET and POST. \"\"\" try: self.raw_requestline = self.rfile.readline(65537) if len(self.raw_requestline) \u003e 65536: self.requestline = '' self.request_version = '' self.command = '' self.send_error(HTTPStatus.REQUEST_URI_TOO_LONG) return if not self.raw_requestline: self.close_connection = True return if not self.parse_request(): # An error code has been sent, just exit return mname = 'do_' + self.command if not hasattr(self, mname): self.send_error( HTTPStatus.NOT_IMPLEMENTED, \"Unsupported method (%r)\" % self.command) return method = getattr(self, mname) method() self.wfile.flush() #actually send the response if not already done. except socket.timeout as e: #a read or a write timed out. Discard this connection self.log_error(\"Request timed out: %r\", e) self.close_connection = True return 可以看到关键的地方是这个 method 方法的调用，而这个 method 其实就是 do_GET、do_POST 等方法。通过 debug 看到，这个方法和 WSGIRequestHandler.run_wsgi 绑定了，即调用了 WSGIRequestHandler.run_wsgi 方法，这是很关键的一个方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 # werkzeug相关代码 class WSGIRequestHandler(BaseHTTPRequestHandler): def run_wsgi(self) -\u003e None: if self.headers.get(\"Expect\", \"\").lower().strip() == \"100-continue\": self.wfile.write(b\"HTTP/1.1 100 Continue\\r\\n\\r\\n\") self.environ = environ = self.make_environ() status_set: t.Optional[str] = None headers_set: t.Optional[t.List[t.Tuple[str, str]]] = None status_sent: t.Optional[str] = None headers_sent: t.Optional[t.List[t.Tuple[str, str]]] = None chunk_response: bool = False def write(data: bytes) -\u003e None: nonlocal status_sent, headers_sent, chunk_response assert status_set is not None, \"write() before start_response\" assert headers_set is not None, \"write() before start_response\" if status_sent is None: status_sent = status_set headers_sent = headers_set try: code_str, msg = status_sent.split(None, 1) except ValueError: code_str, msg = status_sent, \"\" code = int(code_str) self.send_response(code, msg) header_keys = set() for key, value in headers_sent: self.send_header(key, value) header_keys.add(key.lower()) # Use chunked transfer encoding if there is no content # length. Do not use for 1xx and 204 responses. 304 # responses and HEAD requests are also excluded, which # is the more conservative behavior and matches other # parts of the code. # https://httpwg.org/specs/rfc7230.html#rfc.section.3.3.1 if ( not ( \"content-length\" in header_keys or environ[\"REQUEST_METHOD\"] == \"HEAD\" or (100 \u003c= code \u003c 200) or code in {204, 304} ) and self.protocol_version \u003e= \"HTTP/1.1\" ): chunk_response = True self.send_header(\"Transfer-Encoding\", \"chunked\") # Always close the connection. This disables HTTP/1.1 # keep-alive connections. They aren't handled well by # Python's http.server because it doesn't know how to # drain the stream before the next request line. self.send_header(\"Connection\", \"close\") self.end_headers() assert isinstance(data, bytes), \"applications must write bytes\" if data: if chunk_response: self.wfile.write(hex(len(data))[2:].encode()) self.wfile.write(b\"\\r\\n\") self.wfile.write(data) if chunk_response: self.wfile.write(b\"\\r\\n\") self.wfile.flush() def start_response(status, headers, exc_info=None): # type: ignore nonlocal status_set, headers_set if exc_info: try: if headers_sent: raise exc_info[1].with_traceback(exc_info[2]) finally: exc_info = None elif headers_set: raise AssertionError(\"Headers already set\") status_set = status headers_set = headers return write def execute(app: \"WSGIApplication\") -\u003e None: application_iter = app(environ, start_response) try: for data in application_iter: write(data) if not headers_sent: write(b\"\") if chunk_response: self.wfile.write(b\"0\\r\\n\\r\\n\") finally: if hasattr(application_iter, \"close\"): application_iter.close() # type: ignore try: execute(self.server.app) except (ConnectionError, socket.timeout) as e: self.connection_dropped(e, environ) except Exception as e: if self.server.passthrough_errors: raise if status_sent is not None and chunk_response: self.close_connection = True try: # if we haven't yet sent the headers but they are set # we roll back to be able to set them again. if status_sent is None: status_set = None headers_set = None execute(InternalServerError()) except Exception: pass from .debug.tbtools import DebugTraceback msg = DebugTraceback(e).render_traceback_text() self.server.log(\"error\", f\"Error on request:\\n{msg}\") 这段代码里是 execute(self.server.app) 这一段，而这个 server.app 其实就是我们传进来的 flask application了，通过 application_iter = app(environ, start_response) 这一行调用了 Flask 的 __call__ 方法。上面涉及到了很多 werkzeug 相关的代码，然后在这里又回到了 flask。 来看一看这个方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 # Flask相关代码 class Flask(Scaffold): def __call__(self, environ: dict, start_response: t.Callable) -\u003e t.Any: \"\"\"The WSGI server calls the Flask application object as the WSGI application. This calls :meth:`wsgi_app`, which can be wrapped to apply middleware. \"\"\" return self.wsgi_app(environ, start_response) def wsgi_app(self, environ: dict, start_response: t.Callable) -\u003e t.Any: # 创建请求的上下文 ctx = self.request_context(environ) error: t.Optional[BaseException] = None try: try: ctx.push() response = self.full_dispatch_request() except Exception as e: error = e response = self.handle_exception(e) except: # noqa: B001 error = sys.exc_info()[1] raise return response(environ, start_response) finally: if self.should_ignore_error(error): error = None ctx.auto_pop(error) 这段代码首先是创建请求的上下文，然后通过 self.full_dispatch_request() 方法分发请求，我们再来看看 full_dispatch_request 的具体代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 class Flask(Scaffold): def full_dispatch_request(self) -\u003e Response: # Run before_first_request functions if this is the thread's first request. # Inlined to avoid a method call on subsequent requests. # This is deprecated, will be removed in Flask 2.3. if not self._got_first_request: with self._before_request_lock: if not self._got_first_request: for func in self.before_first_request_funcs: self.ensure_sync(func)() self._got_first_request = True try: request_started.send(self) rv = self.preprocess_request() if rv is None: rv = self.dispatch_request() except Exception as e: rv = self.handle_user_exception(e) return self.finalize_request(rv) def dispatch_request(self) -\u003e ft.ResponseReturnValue: req = request_ctx.request if req.routing_exception is not None: self.raise_routing_exception(req) rule: Rule = req.url_rule # type: ignore[assignment] # if we provide automatic options for this URL and the # request came with the OPTIONS method, reply automatically if ( getattr(rule, \"provide_automatic_options\", False) and req.method == \"OPTIONS\" ): return self.make_default_options_response() # otherwise dispatch to the handler for that endpoint view_args: t.Dict[str, t.Any] = req.view_args # type: ignore[assignment] return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args) 能看的到这里 dispatch_request 分发请求，使用 handle_user_exception 处理分发过程中的异常处理。在 dispatch_request 当中，根据url路径，找到相应的方法，并调用，代码为 self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args)。我们再来看一看 self.finalize_request(rv) 做了什么：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # Flask相关代码 class Flask(Scaffold): def finalize_request( self, rv: t.Union[ResponseReturnValue, HTTPException], from_error_handler: bool = False, ) -\u003e Response: response = self.make_response(rv) try: response = self.process_response(response) request_finished.send(self, response=response) except Exception: if not from_error_handler: raise self.logger.exception( \"Request finalizing failed with an error while handling an error\" ) return response 这里的 finalize_request() 就是把 view_functions 返回的结果组装成 Response 并返回，在其中处理了 status、headers、session 等，到此我们的请求处理就结束了。\n",
  "wordCount" : "3486",
  "inLanguage": "en",
  "datePublished": "2022-09-01T20:30:18+08:00",
  "dateModified": "2022-09-19T20:30:18+08:00",
  "author":[{
    "@type": "Person",
    "name": "Puffin Jiang"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://puffinjiang.github.io/posts/tech/flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Puffin Jiang's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cdn.jsdelivr.net/gh/puffinjiang/oss@main/uPic/1661409751396.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://puffinjiang.github.io" accesskey="h" title="Puffin Jiang&#39;s Blog (Alt + H)">
                <img src="https://cdn.jsdelivr.net/gh/puffinjiang/oss@main/uPic/1661396192756.jpeg" alt="" aria-label="logo"
                    height="35">Puffin Jiang&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://puffinjiang.github.io/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
            <li>
                <a href="https://puffinjiang.github.io/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://puffinjiang.github.io/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://puffinjiang.github.io/archives" title="⏱归档">
                    <span>⏱归档</span>
                </a>
            </li>
            <li>
                <a href="https://puffinjiang.github.io/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://puffinjiang.github.io/about" title="🙋🏻‍♂️关于">
                    <span>🙋🏻‍♂️关于</span>
                </a>
            </li>
            <li>
                <a href="https://puffinjiang.github.io/links" title="🤝友链">
                    <span>🤝友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://puffinjiang.github.io">Home</a>&nbsp;»&nbsp;<a href="https://puffinjiang.github.io/posts/">📚文章</a>&nbsp;»&nbsp;<a href="https://puffinjiang.github.io/posts/tech/">👨🏻‍💻技术</a></div>
    <h1 class="post-title">
      Flask源码阅读
    </h1>
    <div class="post-description">
      记录一下阅读Flask源码的过程
    </div>
    <div class="post-meta">










创建:&nbsp;<span title='2022-09-01 20:30:18 +0800 +0800'>2022-09-01</span>&nbsp;|&nbsp;更新:&nbsp;2022-09-19&nbsp;|&nbsp;字数:&nbsp;3486字&nbsp;|&nbsp;时长: 7分钟&nbsp;|&nbsp;
作者：Puffin Jiang

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#flask%e7%ae%80%e4%bb%8b" aria-label="Flask简介">Flask简介</a></li>
                    <li>
                        <a href="#%e4%be%9d%e8%b5%96" aria-label="依赖">依赖</a></li>
                    <li>
                        <a href="#%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b" aria-label="启动流程">启动流程</a></li>
                    <li>
                        <a href="#%e8%af%b7%e6%b1%82%e5%a4%84%e7%90%86%e8%bf%87%e7%a8%8b" aria-label="请求处理过程">请求处理过程</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h1 id="flask简介">Flask简介<a hidden class="anchor" aria-hidden="true" href="#flask简介">#</a></h1>
<blockquote>
<p>Flask是一个“微” python web 框架，只实现了最基本的功能，简单、灵活、可拓展性强。</p>
</blockquote>
<ul>
<li>简单：使用简单，通过 <code>@app.route()</code> 装饰器即可配置路由</li>
<li>灵活：配置灵活，支持多种不同类型的配置方式。可自定义
<ol>
<li>使用dict对象</li>
<li>使用环境变量 <code>app.config.from_envvar()</code></li>
<li>使用配置文件 <code>app.config.from_file()</code>  包括json、toml</li>
</ol>
</li>
<li>可拓展性强：可自定义其他部分的组件，如 <code>flask-SQLAlchemy、flask-session</code> 等</li>
</ul>
<h1 id="依赖">依赖<a hidden class="anchor" aria-hidden="true" href="#依赖">#</a></h1>
<p>flask依赖的核心组件有2个： <code>werkzeug</code> 和 <code>jinja</code>。
<code>jinja</code> 是一个模版引擎，负责模版的渲染，<code>werkzeug</code> 是一个 <a href="https://zh.wikipedia.org/wiki/Web%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BD%91%E5%85%B3%E6%8E%A5%E5%8F%A3">WSGI</a> 工具集的库</p>
<h1 id="启动流程">启动流程<a hidden class="anchor" aria-hidden="true" href="#启动流程">#</a></h1>
<p>在Flask的官方文档中给了一个 &lsquo;Hello World&rsquo; 启动案例，我们本地启动一下</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> flask <span style="color:#fff;font-weight:bold">import</span> Flask
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app = Flask(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@app.route(<span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> hello_world():
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;&lt;p&gt;Hello, World!&lt;/p&gt;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    app.run(<span style="color:#0ff;font-weight:bold">&#34;127.0.0.1&#34;</span>, <span style="color:#ff0;font-weight:bold">5000</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以看出来，启动的时候首先调用了 <code>app.run()</code> 方法，我们来看一下这个方法</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Flask(Scaffold):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> run(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        host: t.Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>        port: t.Optional[<span style="color:#fff;font-weight:bold">int</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>        debug: t.Optional[<span style="color:#fff;font-weight:bold">bool</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>        load_dotenv: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">True</span>,
</span></span><span style="display:flex;"><span>        **options: t.Any,
</span></span><span style="display:flex;"><span>    ) -&gt; <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># Change this into a no-op if the server is invoked from the</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># command line. Have a look at cli.py for more information.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> os.environ.get(<span style="color:#0ff;font-weight:bold">&#34;FLASK_RUN_FROM_CLI&#34;</span>) == <span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">from</span> .debughelpers <span style="color:#fff;font-weight:bold">import</span> explain_ignored_app_run
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            explain_ignored_app_run()
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> get_load_dotenv(load_dotenv):
</span></span><span style="display:flex;"><span>            cli.load_dotenv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># if set, let env vars override previous values</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> <span style="color:#0ff;font-weight:bold">&#34;FLASK_ENV&#34;</span> in os.environ:
</span></span><span style="display:flex;"><span>                self.env = get_env()
</span></span><span style="display:flex;"><span>                self.debug = get_debug_flag()
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">elif</span> <span style="color:#0ff;font-weight:bold">&#34;FLASK_DEBUG&#34;</span> in os.environ:
</span></span><span style="display:flex;"><span>                self.debug = get_debug_flag()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># debug passed to method overrides all other sources</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> debug is not <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>            self.debug = <span style="color:#fff;font-weight:bold">bool</span>(debug)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        server_name = self.config.get(<span style="color:#0ff;font-weight:bold">&#34;SERVER_NAME&#34;</span>)
</span></span><span style="display:flex;"><span>        sn_host = sn_port = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> server_name:
</span></span><span style="display:flex;"><span>            sn_host, _, sn_port = server_name.partition(<span style="color:#0ff;font-weight:bold">&#34;:&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> not host:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> sn_host:
</span></span><span style="display:flex;"><span>                host = sn_host
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                host = <span style="color:#0ff;font-weight:bold">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> port or port == <span style="color:#ff0;font-weight:bold">0</span>:
</span></span><span style="display:flex;"><span>            port = <span style="color:#fff;font-weight:bold">int</span>(port)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">elif</span> sn_port:
</span></span><span style="display:flex;"><span>            port = <span style="color:#fff;font-weight:bold">int</span>(sn_port)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            port = <span style="color:#ff0;font-weight:bold">5000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        options.setdefault(<span style="color:#0ff;font-weight:bold">&#34;use_reloader&#34;</span>, self.debug)
</span></span><span style="display:flex;"><span>        options.setdefault(<span style="color:#0ff;font-weight:bold">&#34;use_debugger&#34;</span>, self.debug)
</span></span><span style="display:flex;"><span>        options.setdefault(<span style="color:#0ff;font-weight:bold">&#34;threaded&#34;</span>, <span style="color:#fff;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cli.show_server_banner(self.env, self.debug, self.name, <span style="color:#fff;font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">from</span> werkzeug.serving <span style="color:#fff;font-weight:bold">import</span> run_simple
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            run_simple(t.cast(<span style="color:#fff;font-weight:bold">str</span>, host), port, self, **options)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">finally</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># reset the first request information if the development server</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># reset normally.  This makes it possible to restart the server</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># without reloader and that stuff from an interactive shell.</span>
</span></span><span style="display:flex;"><span>            self._got_first_request = <span style="color:#fff;font-weight:bold">False</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以看到，前面一部分主要是处理一些启动参数。在参数处理完成之后，调用了 <code>werkzeug.serving </code> 中的 <code>run_simple</code> 函数，能看到这个函数传入了一个 <code>self</code> 参数，即我们的 flask application，我们再进入这个 <code>run_simple </code> 当中。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># werkzeug相关代码</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> run_simple(
</span></span><span style="display:flex;"><span>    hostname: <span style="color:#fff;font-weight:bold">str</span>,
</span></span><span style="display:flex;"><span>    port: <span style="color:#fff;font-weight:bold">int</span>,
</span></span><span style="display:flex;"><span>    application: <span style="color:#0ff;font-weight:bold">&#34;WSGIApplication&#34;</span>,
</span></span><span style="display:flex;"><span>    use_reloader: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>    use_debugger: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>    use_evalex: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">True</span>,
</span></span><span style="display:flex;"><span>    extra_files: t.Optional[t.Iterable[<span style="color:#fff;font-weight:bold">str</span>]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>    exclude_patterns: t.Optional[t.Iterable[<span style="color:#fff;font-weight:bold">str</span>]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>    reloader_interval: <span style="color:#fff;font-weight:bold">int</span> = <span style="color:#ff0;font-weight:bold">1</span>,
</span></span><span style="display:flex;"><span>    reloader_type: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;auto&#34;</span>,
</span></span><span style="display:flex;"><span>    threaded: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>    processes: <span style="color:#fff;font-weight:bold">int</span> = <span style="color:#ff0;font-weight:bold">1</span>,
</span></span><span style="display:flex;"><span>    request_handler: t.Optional[t.Type[WSGIRequestHandler]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>    static_files: t.Optional[t.Dict[<span style="color:#fff;font-weight:bold">str</span>, t.Union[<span style="color:#fff;font-weight:bold">str</span>, t.Tuple[<span style="color:#fff;font-weight:bold">str</span>, <span style="color:#fff;font-weight:bold">str</span>]]]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>    passthrough_errors: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>    ssl_context: t.Optional[_TSSLContextArg] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>) -&gt; <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> not <span style="color:#fff;font-weight:bold">isinstance</span>(port, <span style="color:#fff;font-weight:bold">int</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">raise</span> TypeError(<span style="color:#0ff;font-weight:bold">&#34;port must be an integer&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> static_files:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">from</span> .middleware.shared_data <span style="color:#fff;font-weight:bold">import</span> SharedDataMiddleware
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># 静态文件的加载</span>
</span></span><span style="display:flex;"><span>        application = SharedDataMiddleware(application, static_files)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> use_debugger:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">from</span> .debug <span style="color:#fff;font-weight:bold">import</span> DebuggedApplication
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># Debug调试</span>
</span></span><span style="display:flex;"><span>        application = DebuggedApplication(application, evalex=use_evalex)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> not is_running_from_reloader():
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># 启动前 socket 的准备和检查 ，使用IPV4还是IPV6、端口是否占用</span>
</span></span><span style="display:flex;"><span>        s = prepare_socket(hostname, port)
</span></span><span style="display:flex;"><span>        fd = s.fileno()
</span></span><span style="display:flex;"><span>        os.environ[<span style="color:#0ff;font-weight:bold">&#34;WERKZEUG_SERVER_FD&#34;</span>] = <span style="color:#fff;font-weight:bold">str</span>(fd)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        fd = <span style="color:#fff;font-weight:bold">int</span>(os.environ[<span style="color:#0ff;font-weight:bold">&#34;WERKZEUG_SERVER_FD&#34;</span>])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    srv = make_server(
</span></span><span style="display:flex;"><span>        hostname,
</span></span><span style="display:flex;"><span>        port,
</span></span><span style="display:flex;"><span>        application,
</span></span><span style="display:flex;"><span>        threaded,
</span></span><span style="display:flex;"><span>        processes,
</span></span><span style="display:flex;"><span>        request_handler,
</span></span><span style="display:flex;"><span>        passthrough_errors,
</span></span><span style="display:flex;"><span>        ssl_context,
</span></span><span style="display:flex;"><span>        fd=fd,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> not is_running_from_reloader():
</span></span><span style="display:flex;"><span>        srv.log_startup()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> use_reloader:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">from</span> ._reloader <span style="color:#fff;font-weight:bold">import</span> run_with_reloader
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        run_with_reloader(
</span></span><span style="display:flex;"><span>            srv.serve_forever,
</span></span><span style="display:flex;"><span>            extra_files=extra_files,
</span></span><span style="display:flex;"><span>            exclude_patterns=exclude_patterns,
</span></span><span style="display:flex;"><span>            interval=reloader_interval,
</span></span><span style="display:flex;"><span>            reloader_type=reloader_type,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        srv.serve_forever()
</span></span></code></pre></td></tr></table>
</div>
</div><p>从上面的代码我们可以看到有两处关键的函数调用，一处是 <code>make_server</code> ，另外一处是 <code>serve_forever</code> 。我们先看 <code>make_server</code> 做了什么：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># werkzeug相关代码</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> make_server(
</span></span><span style="display:flex;"><span>    host: <span style="color:#fff;font-weight:bold">str</span>,
</span></span><span style="display:flex;"><span>    port: <span style="color:#fff;font-weight:bold">int</span>,
</span></span><span style="display:flex;"><span>    app: <span style="color:#0ff;font-weight:bold">&#34;WSGIApplication&#34;</span>,
</span></span><span style="display:flex;"><span>    threaded: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>    processes: <span style="color:#fff;font-weight:bold">int</span> = <span style="color:#ff0;font-weight:bold">1</span>,
</span></span><span style="display:flex;"><span>    request_handler: t.Optional[t.Type[WSGIRequestHandler]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>    passthrough_errors: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>    ssl_context: t.Optional[_TSSLContextArg] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>    fd: t.Optional[<span style="color:#fff;font-weight:bold">int</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>) -&gt; BaseWSGIServer:
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> threaded and processes &gt; <span style="color:#ff0;font-weight:bold">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">raise</span> ValueError(<span style="color:#0ff;font-weight:bold">&#34;Cannot have a multi-thread and multi-process server.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> threaded:
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># ThreadedWSGIServer 继承了 BaseWSGIServer</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ThreadedWSGIServer(
</span></span><span style="display:flex;"><span>            host, port, app, request_handler, passthrough_errors, ssl_context, fd=fd
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> processes &gt; <span style="color:#ff0;font-weight:bold">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># ForkingWSGIServer 继承了 BaseWSGIServer</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ForkingWSGIServer(
</span></span><span style="display:flex;"><span>            host,
</span></span><span style="display:flex;"><span>            port,
</span></span><span style="display:flex;"><span>            app,
</span></span><span style="display:flex;"><span>            processes,
</span></span><span style="display:flex;"><span>            request_handler,
</span></span><span style="display:flex;"><span>            passthrough_errors,
</span></span><span style="display:flex;"><span>            ssl_context,
</span></span><span style="display:flex;"><span>            fd=fd,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> BaseWSGIServer(
</span></span><span style="display:flex;"><span>        host, port, app, request_handler, passthrough_errors, ssl_context, fd=fd
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></td></tr></table>
</div>
</div><p>能看到这里是返回了一个 <code>BaseWSGIServer</code> 实例化对象。BaseWSGIServer 在初始化的时候主要做了
两件事情，一是 <code>绑定IP和端口以及监听</code>；二是添加 <code>WSGIRequestHandler</code> 这个请求处理器。</p>
<p>我们再来看看 <code>serve_forever</code> 做了什么：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># werkzeug相关代码</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> BaseWSGIServer(HTTPServer):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> serve_forever(self, poll_interval: <span style="color:#fff;font-weight:bold">float</span> = <span style="color:#ff0;font-weight:bold">0.5</span>) -&gt; <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">super</span>().serve_forever(poll_interval=poll_interval)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> KeyboardInterrupt:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">finally</span>:
</span></span><span style="display:flex;"><span>            self.server_close()
</span></span></code></pre></td></tr></table>
</div>
</div><p>再来进一步看看父类的 <code>serve_forever</code> 做了什么：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># werkzeug相关代码</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> BaseServer:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> serve_forever(self, poll_interval=<span style="color:#ff0;font-weight:bold">0.5</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Handle one request at a time until shutdown.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        Polls for shutdown every poll_interval seconds. Ignores
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        self.timeout. If you need to do periodic tasks, do them in
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        another thread.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self.__is_shut_down.clear()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># XXX: Consider using another file descriptor or connecting to the</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># socket to wake this up instead of polling. Polling reduces our</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># responsiveness to a shutdown request and wastes cpu at all other</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># times.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># I/O多路复用选择器，有poll时选poll</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">with</span> _ServerSelector() <span style="color:#fff;font-weight:bold">as</span> selector:
</span></span><span style="display:flex;"><span>                selector.register(self, selectors.EVENT_READ)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">while</span> not self.__shutdown_request:
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f"># 轮询</span>
</span></span><span style="display:flex;"><span>                    ready = selector.select(poll_interval)
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f"># bpo-35017: shutdown() called during select(), exit immediately.</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> self.__shutdown_request:
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> ready:
</span></span><span style="display:flex;"><span>                        self._handle_request_noblock()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    self.service_actions()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">finally</span>:
</span></span><span style="display:flex;"><span>            self.__shutdown_request = <span style="color:#fff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>            self.__is_shut_down.set()
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以看到的是直接跳到了 <code>BaseServer</code> 这个类，这因为 <code>BaseWSGIServer</code> &ndash;&gt; <code>HTTPServer</code> &ndash;&gt; <code>TCPServer</code> &ndash;&gt; <code>BaseServer</code> 他们之间有继承关系。此处选用了 <code>PollSelector</code> 作为 I/O多路复用选择器，关于I/O多路复用就不详说了。当有活跃的文件描述符时，执行 <code>_handle_request_noblock()</code>方法，到了这里，我们的应用启动并开始监听相关的端口了。</p>
<h1 id="请求处理过程">请求处理过程<a hidden class="anchor" aria-hidden="true" href="#请求处理过程">#</a></h1>
<p>在上面我们已经说到了应用的启动过程，接下来看一看当接收到请求之后是怎么处理的。
上面说到，当有活跃的文件描述符会执行 <code>_handle_request_noblock()</code> 方法，来看一下这个方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># werkzeug相关代码</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> BaseServer:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> _handle_request_noblock(self):
</span></span><span style="display:flex;"><span>        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Handle one request, without blocking.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        I assume that selector.select() has returned that the socket is
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        readable before this function was called, so there should be no risk of
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        blocking in get_request().
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            request, client_address = self.get_request()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> OSError:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> self.verify_request(request, client_address):
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>                self.process_request(request, client_address)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">except</span> Exception:
</span></span><span style="display:flex;"><span>                self.handle_error(request, client_address)
</span></span><span style="display:flex;"><span>                self.shutdown_request(request)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">except</span>:
</span></span><span style="display:flex;"><span>                self.shutdown_request(request)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">raise</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            self.shutdown_request(request)
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这段代码里我们可以看出来，这里是调用了 <code>process_request</code> 方法去处理接收到的request，这个时候就到了我们前面提到的 <code>WSGIRequestHandler</code> 这个请求处理器了。 <code>WSGIRequestHandler</code> 是 <code>BaseRequestHandler</code> 的子类，看看初始化相关的代码：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># werkzeug相关代码</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> BaseRequestHandler:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(self, request, client_address, server):
</span></span><span style="display:flex;"><span>        self.request = request
</span></span><span style="display:flex;"><span>        self.client_address = client_address
</span></span><span style="display:flex;"><span>        self.server = server
</span></span><span style="display:flex;"><span>        self.setup()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            self.handle()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">finally</span>:
</span></span><span style="display:flex;"><span>            self.finish()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> setup(self):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> handle(self):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> finish(self):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">pass</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从上面的代码中可以看到，初始化时调用了 <code>handle</code> 方法，在 <code>handle</code> 方法里是调用了 <code>handle_one_request</code> 方法，我们来看看这个方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># werkzeug相关代码</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> BaseHTTPRequestHandler(socketserver.StreamRequestHandler):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> handle_one_request(self):
</span></span><span style="display:flex;"><span>        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;Handle a single HTTP request.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        You normally don&#39;t need to override this method; see the class
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        __doc__ string for information on how to handle specific HTTP
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        commands such as GET and POST.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            self.raw_requestline = self.rfile.readline(<span style="color:#ff0;font-weight:bold">65537</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">len</span>(self.raw_requestline) &gt; <span style="color:#ff0;font-weight:bold">65536</span>:
</span></span><span style="display:flex;"><span>                self.requestline = <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>                self.request_version = <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>                self.command = <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>                self.send_error(HTTPStatus.REQUEST_URI_TOO_LONG)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> not self.raw_requestline:
</span></span><span style="display:flex;"><span>                self.close_connection = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> not self.parse_request():
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># An error code has been sent, just exit</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>            mname = <span style="color:#0ff;font-weight:bold">&#39;do_&#39;</span> + self.command
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> not <span style="color:#fff;font-weight:bold">hasattr</span>(self, mname):
</span></span><span style="display:flex;"><span>                self.send_error(
</span></span><span style="display:flex;"><span>                    HTTPStatus.NOT_IMPLEMENTED,
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;Unsupported method (</span><span style="color:#0ff;font-weight:bold">%r</span><span style="color:#0ff;font-weight:bold">)&#34;</span> % self.command)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>            method = <span style="color:#fff;font-weight:bold">getattr</span>(self, mname)
</span></span><span style="display:flex;"><span>            method()
</span></span><span style="display:flex;"><span>            self.wfile.flush() <span style="color:#007f7f">#actually send the response if not already done.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> socket.timeout <span style="color:#fff;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">#a read or a write timed out.  Discard this connection</span>
</span></span><span style="display:flex;"><span>            self.log_error(<span style="color:#0ff;font-weight:bold">&#34;Request timed out: </span><span style="color:#0ff;font-weight:bold">%r</span><span style="color:#0ff;font-weight:bold">&#34;</span>, e)
</span></span><span style="display:flex;"><span>            self.close_connection = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到关键的地方是这个 <code>method</code> 方法的调用，而这个 <code>method</code> 其实就是 <code>do_GET、do_POST</code> 等方法。通过 debug 看到，这个方法和 <code>WSGIRequestHandler.run_wsgi</code> 绑定了，即调用了 <code>WSGIRequestHandler.run_wsgi</code> 方法，这是很关键的一个方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">122
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># werkzeug相关代码</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> WSGIRequestHandler(BaseHTTPRequestHandler):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> run_wsgi(self) -&gt; <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> self.headers.get(<span style="color:#0ff;font-weight:bold">&#34;Expect&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>).lower().strip() == <span style="color:#0ff;font-weight:bold">&#34;100-continue&#34;</span>:
</span></span><span style="display:flex;"><span>            self.wfile.write(<span style="color:#0ff;font-weight:bold">b</span><span style="color:#0ff;font-weight:bold">&#34;HTTP/1.1 100 Continue</span><span style="color:#0ff;font-weight:bold">\r\n\r\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.environ = environ = self.make_environ()
</span></span><span style="display:flex;"><span>        status_set: t.Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>        headers_set: t.Optional[t.List[t.Tuple[<span style="color:#fff;font-weight:bold">str</span>, <span style="color:#fff;font-weight:bold">str</span>]]] = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>        status_sent: t.Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>        headers_sent: t.Optional[t.List[t.Tuple[<span style="color:#fff;font-weight:bold">str</span>, <span style="color:#fff;font-weight:bold">str</span>]]] = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>        chunk_response: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">def</span> write(data: <span style="color:#fff;font-weight:bold">bytes</span>) -&gt; <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">nonlocal</span> status_sent, headers_sent, chunk_response
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">assert</span> status_set is not <span style="color:#fff;font-weight:bold">None</span>, <span style="color:#0ff;font-weight:bold">&#34;write() before start_response&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">assert</span> headers_set is not <span style="color:#fff;font-weight:bold">None</span>, <span style="color:#0ff;font-weight:bold">&#34;write() before start_response&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> status_sent is <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>                status_sent = status_set
</span></span><span style="display:flex;"><span>                headers_sent = headers_set
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>                    code_str, msg = status_sent.split(<span style="color:#fff;font-weight:bold">None</span>, <span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">except</span> ValueError:
</span></span><span style="display:flex;"><span>                    code_str, msg = status_sent, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                code = <span style="color:#fff;font-weight:bold">int</span>(code_str)
</span></span><span style="display:flex;"><span>                self.send_response(code, msg)
</span></span><span style="display:flex;"><span>                header_keys = <span style="color:#fff;font-weight:bold">set</span>()
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">for</span> key, value in headers_sent:
</span></span><span style="display:flex;"><span>                    self.send_header(key, value)
</span></span><span style="display:flex;"><span>                    header_keys.add(key.lower())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># Use chunked transfer encoding if there is no content</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># length. Do not use for 1xx and 204 responses. 304</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># responses and HEAD requests are also excluded, which</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># is the more conservative behavior and matches other</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># parts of the code.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># https://httpwg.org/specs/rfc7230.html#rfc.section.3.3.1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (
</span></span><span style="display:flex;"><span>                    not (
</span></span><span style="display:flex;"><span>                        <span style="color:#0ff;font-weight:bold">&#34;content-length&#34;</span> in header_keys
</span></span><span style="display:flex;"><span>                        or environ[<span style="color:#0ff;font-weight:bold">&#34;REQUEST_METHOD&#34;</span>] == <span style="color:#0ff;font-weight:bold">&#34;HEAD&#34;</span>
</span></span><span style="display:flex;"><span>                        or (<span style="color:#ff0;font-weight:bold">100</span> &lt;= code &lt; <span style="color:#ff0;font-weight:bold">200</span>)
</span></span><span style="display:flex;"><span>                        or code in {<span style="color:#ff0;font-weight:bold">204</span>, <span style="color:#ff0;font-weight:bold">304</span>}
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                    and self.protocol_version &gt;= <span style="color:#0ff;font-weight:bold">&#34;HTTP/1.1&#34;</span>
</span></span><span style="display:flex;"><span>                ):
</span></span><span style="display:flex;"><span>                    chunk_response = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                    self.send_header(<span style="color:#0ff;font-weight:bold">&#34;Transfer-Encoding&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;chunked&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># Always close the connection. This disables HTTP/1.1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># keep-alive connections. They aren&#39;t handled well by</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># Python&#39;s http.server because it doesn&#39;t know how to</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># drain the stream before the next request line.</span>
</span></span><span style="display:flex;"><span>                self.send_header(<span style="color:#0ff;font-weight:bold">&#34;Connection&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;close&#34;</span>)
</span></span><span style="display:flex;"><span>                self.end_headers()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">assert</span> <span style="color:#fff;font-weight:bold">isinstance</span>(data, <span style="color:#fff;font-weight:bold">bytes</span>), <span style="color:#0ff;font-weight:bold">&#34;applications must write bytes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> data:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> chunk_response:
</span></span><span style="display:flex;"><span>                    self.wfile.write(<span style="color:#fff;font-weight:bold">hex</span>(<span style="color:#fff;font-weight:bold">len</span>(data))[<span style="color:#ff0;font-weight:bold">2</span>:].encode())
</span></span><span style="display:flex;"><span>                    self.wfile.write(<span style="color:#0ff;font-weight:bold">b</span><span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\r\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                self.wfile.write(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> chunk_response:
</span></span><span style="display:flex;"><span>                    self.wfile.write(<span style="color:#0ff;font-weight:bold">b</span><span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\r\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            self.wfile.flush()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">def</span> start_response(status, headers, exc_info=<span style="color:#fff;font-weight:bold">None</span>):  <span style="color:#007f7f"># type: ignore</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">nonlocal</span> status_set, headers_set
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> exc_info:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> headers_sent:
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">raise</span> exc_info[<span style="color:#ff0;font-weight:bold">1</span>].with_traceback(exc_info[<span style="color:#ff0;font-weight:bold">2</span>])
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">finally</span>:
</span></span><span style="display:flex;"><span>                    exc_info = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">elif</span> headers_set:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">raise</span> AssertionError(<span style="color:#0ff;font-weight:bold">&#34;Headers already set&#34;</span>)
</span></span><span style="display:flex;"><span>            status_set = status
</span></span><span style="display:flex;"><span>            headers_set = headers
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> write
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">def</span> execute(app: <span style="color:#0ff;font-weight:bold">&#34;WSGIApplication&#34;</span>) -&gt; <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>            application_iter = app(environ, start_response)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">for</span> data in application_iter:
</span></span><span style="display:flex;"><span>                    write(data)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> not headers_sent:
</span></span><span style="display:flex;"><span>                    write(<span style="color:#0ff;font-weight:bold">b</span><span style="color:#0ff;font-weight:bold">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> chunk_response:
</span></span><span style="display:flex;"><span>                    self.wfile.write(<span style="color:#0ff;font-weight:bold">b</span><span style="color:#0ff;font-weight:bold">&#34;0</span><span style="color:#0ff;font-weight:bold">\r\n\r\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">finally</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">hasattr</span>(application_iter, <span style="color:#0ff;font-weight:bold">&#34;close&#34;</span>):
</span></span><span style="display:flex;"><span>                    application_iter.close()  <span style="color:#007f7f"># type: ignore</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            execute(self.server.app)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> (ConnectionError, socket.timeout) <span style="color:#fff;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>            self.connection_dropped(e, environ)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> Exception <span style="color:#fff;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> self.server.passthrough_errors:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> status_sent is not <span style="color:#fff;font-weight:bold">None</span> and chunk_response:
</span></span><span style="display:flex;"><span>                self.close_connection = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># if we haven&#39;t yet sent the headers but they are set</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># we roll back to be able to set them again.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> status_sent is <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>                    status_set = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>                    headers_set = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>                execute(InternalServerError())
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">except</span> Exception:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">from</span> .debug.tbtools <span style="color:#fff;font-weight:bold">import</span> DebugTraceback
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            msg = DebugTraceback(e).render_traceback_text()
</span></span><span style="display:flex;"><span>            self.server.log(<span style="color:#0ff;font-weight:bold">&#34;error&#34;</span>, <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Error on request:</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">{</span>msg<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码里是 <code>execute(self.server.app)</code> 这一段，而这个 <code>server.app</code> 其实就是我们传进来的 flask application了，通过 <code>application_iter = app(environ, start_response)</code> 这一行调用了 Flask 的 <code>__call__</code> 方法。上面涉及到了很多 <code>werkzeug</code> 相关的代码，然后在这里又回到了 <code>flask</code>。 来看一看这个方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#007f7f"># Flask相关代码
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>class Flask(Scaffold):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    def __call__(self, environ: dict, start_response: t.Callable) -&gt; t.Any:
</span></span><span style="display:flex;"><span>        <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;The WSGI server calls the Flask application object as the
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        WSGI application. This calls :meth:`wsgi_app`, which can be
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        wrapped to apply middleware.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> self.wsgi_app(environ, start_response)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    def wsgi_app(self, environ: dict, start_response: t.Callable) -&gt; t.Any:
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># 创建请求的上下文
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ctx = self.request_context(environ)
</span></span><span style="display:flex;"><span>        error: t.Optional[BaseException] = None
</span></span><span style="display:flex;"><span>        try:
</span></span><span style="display:flex;"><span>            try:
</span></span><span style="display:flex;"><span>                ctx.push()
</span></span><span style="display:flex;"><span>                response = self.full_dispatch_request()
</span></span><span style="display:flex;"><span>            except Exception <span style="color:#fff;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>                error = e
</span></span><span style="display:flex;"><span>                response = self.handle_exception(e)
</span></span><span style="display:flex;"><span>            except:  <span style="color:#007f7f"># noqa: B001
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                error = sys.exc_info()[<span style="color:#ff0;font-weight:bold">1</span>]
</span></span><span style="display:flex;"><span>                raise
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> response(environ, start_response)
</span></span><span style="display:flex;"><span>        finally:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> self.should_ignore_error(error):
</span></span><span style="display:flex;"><span>                error = None
</span></span><span style="display:flex;"><span>            ctx.auto_pop(error)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码首先是创建请求的上下文，然后通过 <code>self.full_dispatch_request()</code> 方法分发请求，我们再来看看 <code>full_dispatch_request</code> 的具体代码：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Flask(Scaffold):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> full_dispatch_request(self) -&gt; Response:
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># Run before_first_request functions if this is the thread&#39;s first request.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># Inlined to avoid a method call on subsequent requests.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># This is deprecated, will be removed in Flask 2.3.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> not self._got_first_request:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">with</span> self._before_request_lock:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> not self._got_first_request:
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">for</span> func in self.before_first_request_funcs:
</span></span><span style="display:flex;"><span>                        self.ensure_sync(func)()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    self._got_first_request = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            request_started.send(self)
</span></span><span style="display:flex;"><span>            rv = self.preprocess_request()
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> rv is <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>                rv = self.dispatch_request()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> Exception <span style="color:#fff;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>            rv = self.handle_user_exception(e)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> self.finalize_request(rv)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> dispatch_request(self) -&gt; ft.ResponseReturnValue:
</span></span><span style="display:flex;"><span>        req = request_ctx.request
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> req.routing_exception is not <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>            self.raise_routing_exception(req)
</span></span><span style="display:flex;"><span>        rule: Rule = req.url_rule  <span style="color:#007f7f"># type: ignore[assignment]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># if we provide automatic options for this URL and the</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># request came with the OPTIONS method, reply automatically</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">getattr</span>(rule, <span style="color:#0ff;font-weight:bold">&#34;provide_automatic_options&#34;</span>, <span style="color:#fff;font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>            and req.method == <span style="color:#0ff;font-weight:bold">&#34;OPTIONS&#34;</span>
</span></span><span style="display:flex;"><span>        ):
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> self.make_default_options_response()
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># otherwise dispatch to the handler for that endpoint</span>
</span></span><span style="display:flex;"><span>        view_args: t.Dict[<span style="color:#fff;font-weight:bold">str</span>, t.Any] = req.view_args  <span style="color:#007f7f"># type: ignore[assignment]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
</span></span></code></pre></td></tr></table>
</div>
</div><p>能看的到这里 <code>dispatch_request</code> 分发请求，使用 <code>handle_user_exception</code> 处理分发过程中的异常处理。在 <code>dispatch_request</code> 当中，根据url路径，找到相应的方法，并调用，代码为 <code>self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args)</code>。我们再来看一看 <code>self.finalize_request(rv)</code> 做了什么：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># Flask相关代码</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Flask(Scaffold):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> finalize_request(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        rv: t.Union[ResponseReturnValue, HTTPException],
</span></span><span style="display:flex;"><span>        from_error_handler: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>    ) -&gt; Response:
</span></span><span style="display:flex;"><span>        response = self.make_response(rv)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            response = self.process_response(response)
</span></span><span style="display:flex;"><span>            request_finished.send(self, response=response)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> Exception:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> not from_error_handler:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">raise</span>
</span></span><span style="display:flex;"><span>            self.logger.exception(
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;Request finalizing failed with an error while handling an error&#34;</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> response
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里的 <code>finalize_request()</code> 就是把 <code>view_functions</code> 返回的结果组装成 Response 并返回，在其中处理了 <code>status、headers、session</code> 等，到此我们的请求处理就结束了。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://puffinjiang.github.io/tags/flask/">Flask</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://puffinjiang.github.io/posts/tool/upgradebrewerrorafterupdatingmacos/">
    <span class="title">« Prev</span>
    <br>
    <span>Upgrade brew error after updating MacOS</span>
  </a>
  <a class="next" href="https://puffinjiang.github.io/posts/tech/celery%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E8%A7%A3%E5%86%B3/">
    <span class="title">Next »</span>
    <br>
    <span>Celery内存泄漏解决</span>
  </a>
</nav>

  </footer><script src="https://utteranc.es/client.js"
    repo="puffinjiang/blog-comment"
    issue-term="pathname"
    label="Comment"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://puffinjiang.github.io">Puffin Jiang&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
